- hosts: db
  become: true
  pre_tasks:
    # Can't define ansible_host because of ansible bug https://github.com/ansible/ansible/issues/16776
    - name: set host
      set_fact:
        db_host: "{{ ansible_host }}"
        db_subnet: "{{ ansible_host | ipsubnet(24,0) }}"
  roles:
    - role: geerlingguy.postgresql
      vars:
        postgresql_databases:
          - name: workshop
        postgresql_users:
          - name: workshop
            password: supersecure
        postgresql_hba_entries:
          - {type: local, database: all, user: postgres, auth_method: peer}
          - {type: local, database: all, user: all, auth_method: peer}
          - {type: host, database: all, user: all, address: '127.0.0.1/32', auth_method: "{{ postgresql_auth_method }}"}
          - {type: host, database: all, user: all, address: '::1/128', auth_method: "{{ postgresql_auth_method }}"}
          - {type: host, database: workshop, user: workshop, address: "'{{ db_subnet }}'", auth_method: "{{ postgresql_auth_method }}"}
        postgresql_global_config_options:
        - option: unix_socket_directories
          value: '{{ postgresql_unix_socket_directories | join(",") }}'
        - option: listen_addresses
          value: "localhost,{{ db_host }}"

